#!/bin/bash -e

# Copyright (C) 2017 Oliver Schulz <oschulz@mpp.mpg.de>
#
# Licensed under the Apache License, Version 2.0 (the "License"); 
# you may not use this file except in compliance with the License. 
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software 
# distributed under the License is distributed on an "AS IS" BASIS, 
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. 
# See the License for the specific language governing permissions and 
# limitations under the License.


if [ -f "./docker-repository" ] ; then
    reponame=`cat ./docker-repository`
    imgname=`echo "${reponame}" | rev | cut -d '/' -f 1 | rev`
    orgname=`echo "${reponame}" | rev | cut -d '/' -f 2 | rev`
    regname=`echo "${reponame}" | rev | cut -d '/' -f 3- | rev`
else
    # echo "DEBUG: DOCKER_IMG_NAME=${DOCKER_IMG_NAME}" >&2

    if (echo "${DOCKER_IMG_NAME}" | grep -q '/'); then
        orgname=`echo "${DOCKER_IMG_NAME}" | cut -d '/' -f 1`
        imgname=`echo "${DOCKER_IMG_NAME}" | cut -d '/' -f 2-`
    else
        orgname=""
        imgname="${DOCKER_IMG_NAME}"
    fi
    regname=""

    # echo "DEBUG: orgname=${orgname}" >&2
    # echo "DEBUG: imgname=${imgname}" >&2

    if [ -z "${imgname}" ] ; then
        pwdname="$(basename `pwd` | sed 's/_[^_]*$//')"

        if (echo "${pwdname}" | grep -q '_'); then
            orgname=`echo "${pwdname}" | cut -d '_' -f 1`
            imgname=`echo "${pwdname}" | cut -d '_' -f 2-`
        else
            orgname=""
            imgname="${pwdname}"
        fi
    fi

    if [ -z "${orgname}" ] ; then
        reponame="${imgname}"
    else
        reponame="${orgname}/${imgname}"
    fi
fi

# echo "DEBUG: imgname=${imgname}" >&2
# echo "DEBUG: orgname=${orgname}" >&2
# echo "DEBUG: regname=${regname}" >&2
# echo "DEBUG: reponame=${reponame}" >&2

git_desc=`git describe --all | sed 's|^.*/||'`

if [ "${git_desc}" = "main" ] ; then
    tag="latest"
elif [ "${git_desc}" = "master" ] ; then
    tag="latest"
elif [ "${git_desc}" = "dev" ] ; then
    tag="latest"
else
    tag="${git_desc}"
fi

DOCKER_IMG_NAME="${reponame}:${tag}"

echo "${DOCKER_IMG_NAME}"
